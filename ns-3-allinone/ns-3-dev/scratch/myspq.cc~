#include <fstream>
#include <string>
#include <iostream>
#include <vector>
#include<typeinfo>
#include "ns3/output-stream-wrapper.h"
#include "ns3/core-module.h"
#include "ns3/applications-module.h"
#include "ns3/internet-module.h"
#include "ns3/network-module.h"
#include "ns3/point-to-point-module.h"
#include "ns3/flow-monitor-helper.h"
#include "ns3/ipv4-global-routing-helper.h"
#include "src/json/json.h"
#include "ns3/myspq.h"
#include "ns3/netanim-module.h"
#include "ns3/udp-client-server-helper.h"

using namespace ns3;

NS_LOG_COMPONENT_DEFINE ("MYSPQ");

int main (int argc, char *argv[])
{
	Config::SetDefault ("ns3::QueueBase::MaxSize", StringValue ("60000p"));
	LogComponentEnable ("MYSPQ", LOG_LEVEL_INFO);
	
	CommandLine cmd;
	int inputCount = 1;
	int outputCount = 1;
	cmd.AddValue ("inputCount","the number of inputServer(s)",inputCount);
	cmd.AddValue ("outputCount","the number of outputServer(s)", outputCount);
	cmd.Parse (argc, argv);
	
	//ports=9 10 11 12 13 14 15 16
	//cout << "inputCount:" << inputCount << endl;
	
	NS_LOG_INFO ("Install nodes");
	NodeContainer inputServers;
	inputServers.Create(inputCount);
	NodeContainer outputServers;
	outputServers.Create(outputCount);
	NodeContainer router;
	router.Create(1);
	
	NS_LOG_INFO ("Install channels");
	NodeContainer in_router[inputCount];
	NodeContainer router_out[outputCount];
	PointToPointHelper p2p_in[inputCount];
	PointToPointHelper p2p_out[outputCount];
	
	
	//no spq test
	NetDeviceContainer d_in[inputCount];
	for(int n=0;n<inputCount;n++){
		p2p_in[n].SetDeviceAttribute ("DataRate", StringValue ("1Mbps"));
		in_router[n]=NodeContainer(inputServers.Get(n),router.Get(0));
		d_in[n] = p2p_in[n].Install (in_router[n]);
	}
/*	NetDeviceContainer d_out[outputCount];
	for(int m=0;m<outputCount;m++)
	{
		p2p_out[m].SetDeviceAttribute ("DataRate", StringValue ("1Mbps"));
		router_out[m]=NodeContainer(router.Get(0),outputServers.Get(m));
		d_out[m] = p2p_out[m].Install (router_out[m]);
	}*/
	
	int numQueues = 8;
	std::string queueLevels = "01234567";
	/*
	NetDeviceContainer d_in[inputCount];			   
	for(int n=0;n<inputCount;n++)
	{
		p2p_in[n].SetDeviceAttribute ("DataRate", StringValue ("1Mbps"));
		p2p_in[n].SetQueue ("ns3::MYSPQ",        
					  "Mode", StringValue ("QUEUE_MODE_PACKETS"),
                     "NumberOfQueues", IntegerValue (numQueues),
                     "QueueLevels", StringValue (queueLevels),
                     "Setup", IntegerValue (1)); 
		in_router[n]=NodeContainer(inputServers.Get(n),router.Get(0));
		d_in[n] = p2p_in[n].Install (in_router[n]);
	}
	*/
	NetDeviceContainer d_out[outputCount];
	for(int m=0;m<outputCount;m++)
	{
		p2p_out[m].SetDeviceAttribute ("DataRate", StringValue ("1Mbps"));
		p2p_out[m].SetQueue ("ns3::MYSPQ",        
					  "Mode", StringValue ("QUEUE_MODE_PACKETS"),
                     "NumberOfQueues", IntegerValue (numQueues),
                     "QueueLevels", StringValue (queueLevels),
                     "Setup", IntegerValue (1)); 
		router_out[m]=NodeContainer(outputServers.Get(m),router.Get(0));
		d_out[m] = p2p_out[m].Install (router_out[m]);
	}
	
	NS_LOG_INFO ("Assign addresses");
	InternetStackHelper stack;
	stack.Install(inputServers);
	stack.Install(outputServers);
	stack.Install(router);
	
	Ipv4AddressHelper address;
	address.SetBase ("10.1.1.0", "255.255.255.0");

	Ipv4InterfaceContainer ii[inputCount];
	for(int n=0;n<inputCount;n++)
	{
		ii[n]=address.Assign(d_in[n]);
	}
	
	Ipv4InterfaceContainer ii2[outputCount];
	for(int m=0;m<outputCount;m++)
	{
		ii2[m]=address.Assign(d_out[m]);
	}
	
//	Ipv4GlobalRoutingHelper::PopulateRoutingTables ();
	
	Packet::EnablePrinting ();
	double start = 1.0;
	double stop = 100.0;   
	
	NS_LOG_INFO ("Install Server App");
	
	uint16_t port[numQueues]={9,10,11,12,13,14,15,16};
	std::vector<UdpServerHelper *> servers;	
	for(int i=0;i<numQueues;i++){
		servers.push_back (new UdpServerHelper(port[i]));
	}

	ApplicationContainer apps;
	for(int m=0;m<outputCount;m++){
		for(int i=0;i<numQueues;i++){
			UdpServerHelper* u = servers.at(i);
			apps = u->Install(outputServers.Get(m));
			apps.Start (Seconds (start+1));
			apps.Stop (Seconds (stop));
		}
	}
	
	//
	// Create MYSPQ application to send UDP datagrams from inputservers to outputservers
	//
	NS_LOG_INFO ("Install Client App");
	uint32_t packetSize = 1024;
	uint32_t maxPacketCount = 32;
	Time interPacketInterval = MicroSeconds (100);
	
	double t = 0.0;
	for(int n = 0;n < inputCount; n++){
		for(int m = 0;m < outputCount; m++){
			for(int i = 0;i<numQueues;i++){
				UdpClientHelper* client = new UdpClientHelper(ii2[m].GetAddress(1),port[i]);
				client->SetAttribute ("MaxPackets", UintegerValue (maxPacketCount));
				client->SetAttribute ("Interval", TimeValue (interPacketInterval));
				client->SetAttribute ("PacketSize", UintegerValue (packetSize));
				apps = client->Install (inputServers.Get (n));
				cout << "inputServer:" <<n<<":"<<ii[n].GetAddress(0)<<"install app to node:"<<m<<":"<<ii2[m].GetAddress(1)<<"port:"<<port[i]<< endl;
				apps.Start (Seconds (start + 2 + t));
				apps.Stop (Seconds (stop));
				t = t + 0.1;
			}	
		}	
	}
	
	AsciiTraceHelper ascii;
	std::string fileName ="result/myspq-";
	for(int n=0;n<inputCount;n++){
		p2p_in[n].EnablePcapAll(fileName,false);
	}
	
	for(int m=0;m<outputCount;m++){
		p2p_out[m].EnablePcapAll(fileName,false);
	}
	//
	// Now, do the actual simulation.
        //
        Ipv4StaticRoutingHelper routingHelper;
	Ptr<OutputStreamWrapper> routingStream = Create<OutputStreamWrapper>("routes.tr",std::ios::out);
	routingHelper.PrintRoutingTableAt(Seconds(5.0),router.Get(0),routingStream);
       	AnimationInterface anim ("myspq.xml");
	anim.EnablePacketMetadata(true);
	for(int n=0;n<inputCount;n++){
                anim.SetConstantPosition (inputServers.Get (n), 10 , (n+1)*10);
        }
        anim.SetConstantPosition (router.Get (0), 20 , 20);
        for(int m=0;m<outputCount;m++){
                anim.SetConstantPosition (outputServers.Get (m), 30,(m+1)*10);
        }
	NS_LOG_INFO ("Start!");
       	Simulator::Run ();	
       	Simulator::Simulator::Destroy ();
	NS_LOG_INFO ("Done.");
	 
	return 0;
}



	

		
	
	
		
		
		
		
	
	
	
	
	
	
	
